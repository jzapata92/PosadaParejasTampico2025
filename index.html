<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Coloca el archivo de audio posada.mp3 en la misma carpeta que este index.html. -->
  <!-- Coloca la imagen hero_santa.png (relación 16:9) en la misma carpeta que este index.html. -->
  <!-- Configura los valores de FORM_ENDPOINT y READ_ENDPOINT (si aplica) con tu Google Apps Script. -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Posada de Parejas 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --crimson-900: #2a0006;
      --crimson-700: #560012;
      --crimson-500: #b00024;
      --crimson-300: #ff3355;
      --emerald: #2af8a5;
      --emerald-soft: rgba(42, 248, 165, 0.4);
      --gold: #f5d57c;
      --gold-soft: rgba(245, 213, 124, 0.3);
      --ink: rgba(10, 0, 0, 0.75);
      --glass: rgba(10, 0, 0, 0.55);
      --glass-strong: rgba(10, 0, 0, 0.75);
      --border: rgba(255, 255, 255, 0.14);
      --text-primary: #fffaf2;
      --text-muted: rgba(255, 245, 235, 0.68);
      --shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      --radius-xl: 34px;
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 12px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      background: radial-gradient(circle at 20% 15%, rgba(255, 255, 255, 0.08), transparent 60%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.12), transparent 65%),
        linear-gradient(145deg, var(--crimson-900), var(--crimson-700) 45%, var(--crimson-500));
      overflow-x: hidden;
      position: relative;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: -20vh;
      background: conic-gradient(from 140deg, rgba(255, 255, 255, 0.07) 0deg, transparent 120deg);
      filter: blur(120px);
      opacity: 0.85;
      animation: aurora 20s linear infinite alternate;
      z-index: 0;
      pointer-events: none;
    }

    body::after {
      animation-duration: 28s;
      animation-direction: alternate-reverse;
      transform: rotate(20deg);
    }

    @keyframes aurora {
      0% { transform: translate3d(-8%, -6%, 0) scale(1.05); }
      50% { transform: translate3d(8%, 6%, 0) scale(1.08); }
      100% { transform: translate3d(-10%, 2%, 0) scale(1.04); }
    }

    .garland-frame::before,
    .garland-frame::after {
      content: "";
      position: fixed;
      inset: 16px;
      border-radius: 42px;
      border: 2px solid var(--gold-soft);
      box-shadow: 0 0 12px var(--gold-soft), inset 0 0 20px rgba(255, 255, 255, 0.15);
      pointer-events: none;
      z-index: 4;
      animation: twinkle 5s ease-in-out infinite;
    }

    .garland-frame::after {
      inset: 26px;
      border-radius: 56px;
      border: 1px dashed rgba(245, 213, 124, 0.55);
      mix-blend-mode: screen;
      animation-delay: 1.6s;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.55; filter: drop-shadow(0 0 6px rgba(245, 213, 124, 0.7)); }
      40% { opacity: 1; filter: drop-shadow(0 0 16px rgba(245, 213, 124, 1)); }
      70% { opacity: 0.72; }
    }

    #snow-canvas,
    #confetti-canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      pointer-events: none;
    }

    #confetti-canvas {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    main {
      position: relative;
      z-index: 5;
      padding: 110px 20px 80px;
      max-width: 1180px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 48px;
    }

    header.hero {
      display: grid;
      gap: 32px;
      align-items: center;
      justify-items: center;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.1), transparent 45%);
      border-radius: var(--radius-xl);
      padding: clamp(32px, 6vw, 64px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px) saturate(140%);
    }

    .hero-content {
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .hero-kicker {
      font-family: 'Cinzel', serif;
      font-size: 0.95rem;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--gold);
    }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: clamp(2.8rem, 8vw, 4.6rem);
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .hero-location {
      font-size: clamp(1.1rem, 3vw, 1.5rem);
      letter-spacing: 0.4em;
      text-transform: uppercase;
      color: var(--emerald);
      margin-bottom: 12px;
    }

    .countdown {
      display: grid;
      grid-template-columns: repeat(2, minmax(120px, 1fr));
      gap: 14px;
      width: min(420px, 90vw);
      margin: 0 auto;
    }

    .countdown .time-block {
      background: var(--glass);
      border-radius: var(--radius-lg);
      padding: 18px 14px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }

    .time-value {
      font-size: 2.6rem;
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .time-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.4em;
      color: var(--text-muted);
    }

    .hero-img {
      width: min(560px, 92vw);
      aspect-ratio: 16 / 9;
      border-radius: var(--radius-xl);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 26px 60px rgba(0, 0, 0, 0.5);
      transform: translateZ(0);
      transition: transform 0.5s ease, box-shadow 0.5s ease;
    }

    .hero-img:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 36px 80px rgba(0, 0, 0, 0.55);
    }

    .hero-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .info-grid {
      display: grid;
      gap: 28px;
    }

    .card {
      background: var(--glass);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      padding: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px) saturate(160%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid rgba(255, 255, 255, 0.04);
      pointer-events: none;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 1rem;
      margin: 0;
      color: var(--gold);
    }

    .pill {
      background: rgba(42, 248, 165, 0.15);
      color: var(--emerald);
      border: 1px solid rgba(42, 248, 165, 0.25);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    dl.meta {
      display: grid;
      gap: 18px;
      margin: 0;
    }

    dl.meta div {
      display: grid;
      gap: 4px;
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    dl.meta div:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    dt {
      font-size: 0.75rem;
      letter-spacing: 0.28em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    dd {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
    }

    a.cta-link {
      align-self: flex-start;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 22px;
      border-radius: var(--radius-md);
      background: linear-gradient(120deg, rgba(42, 248, 165, 0.2), rgba(42, 248, 165, 0.05));
      color: var(--emerald);
      text-decoration: none;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      border: 1px solid rgba(42, 248, 165, 0.25);
      transition: var(--transition);
      font-size: 0.75rem;
      font-weight: 600;
    }

    a.cta-link::after {
      content: "➜";
      transition: transform 0.3s ease;
      font-size: 0.9rem;
    }

    a.cta-link:hover,
    a.cta-link:focus-visible {
      background: rgba(42, 248, 165, 0.28);
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(42, 248, 165, 0.28);
    }

    a.cta-link:hover::after,
    a.cta-link:focus-visible::after {
      transform: translateX(6px);
    }

    .contribution {
      background: var(--glass-strong);
      border-radius: var(--radius-xl);
      padding: 28px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      display: grid;
      gap: 18px;
      box-shadow: var(--shadow);
    }

    .contribution h3 {
      font-family: 'Cinzel', serif;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 1rem;
      color: var(--gold);
    }

    .contribution p {
      margin: 0;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .account-grid {
      display: grid;
      gap: 12px;
    }

    .account-grid span {
      font-weight: 500;
      letter-spacing: 0.04em;
    }

    .stats-section {
      display: grid;
      gap: 28px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
    }

    .stat-card {
      padding: 22px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.05);
      display: grid;
      gap: 10px;
    }

    .stat-label {
      text-transform: uppercase;
      letter-spacing: 0.26em;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .chart-grid {
      display: grid;
      gap: 18px;
    }

    .chart-card {
      padding: 18px;
      border-radius: var(--radius-lg);
      background: rgba(10, 0, 0, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.12);
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }

    .chart-card h4 {
      margin: 0;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.24em;
      color: var(--gold);
    }

    canvas.chart {
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
    }

    form {
      display: grid;
      gap: 24px;
      background: var(--glass-strong);
      padding: 32px;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: var(--shadow);
    }

    .form-grid {
      display: grid;
      gap: 18px;
    }

    @media (min-width: 768px) {
      .info-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .chart-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      form .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      form .form-grid .full {
        grid-column: span 2;
      }
    }

    label {
      display: grid;
      gap: 8px;
      font-size: 0.85rem;
      letter-spacing: 0.04em;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.25);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--emerald);
      box-shadow: 0 0 0 2px rgba(42, 248, 165, 0.35);
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    input[type="file"] {
      padding: 12px;
      cursor: pointer;
    }

    .radio-group,
    .toggle-group {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    button {
      padding: 14px 26px;
      border-radius: var(--radius-md);
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      font-weight: 600;
      background: linear-gradient(120deg, rgba(42, 248, 165, 0.25), rgba(245, 213, 124, 0.25));
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
    }

    button:hover,
    button:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 20px 45px rgba(42, 248, 165, 0.32);
    }

    .status-message {
      font-size: 0.85rem;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .status-message.success {
      color: var(--emerald);
    }

    .status-message.error {
      color: #ff9595;
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 60px;
    }

    .access-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 50% 20%, rgba(240, 240, 240, 0.14), transparent 60%),
        linear-gradient(160deg, rgba(10, 0, 0, 0.9), rgba(10, 0, 0, 0.98));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      backdrop-filter: blur(12px);
      transition: opacity 0.4s ease;
    }

    .access-panel {
      background: rgba(10, 0, 0, 0.78);
      border-radius: var(--radius-xl);
      padding: 38px;
      display: grid;
      gap: 24px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: var(--shadow);
      text-align: center;
      width: min(420px, 92vw);
    }

    .access-panel h2 {
      margin: 0;
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 0.22em;
      font-size: 1.4rem;
    }

    .hidden {
      display: none !important;
    }

    @media (min-width: 1024px) {
      header.hero {
        grid-template-columns: 1.1fr 0.9fr;
        text-align: left;
        justify-items: stretch;
      }

      .hero-content {
        text-align: left;
        align-items: flex-start;
      }

      .countdown {
        grid-template-columns: repeat(4, minmax(120px, 1fr));
      }

      .info-grid {
        grid-template-columns: 1.2fr 1fr;
      }

      .chart-grid {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }
  </style>
</head>
<body>
  <div class="garland-frame"></div>
  <canvas id="snow-canvas"></canvas>
  <canvas id="confetti-canvas"></canvas>

  <div class="access-overlay" id="access-overlay" role="dialog" aria-modal="true" aria-labelledby="access-title">
    <div class="access-panel">
      <h2 id="access-title">Acceso</h2>
      <p>Ingresa la contraseña para desbloquear la invitación.</p>
      <label>
        Contraseña
        <input type="password" id="access-password" autocomplete="current-password" aria-required="true">
      </label>
      <button id="access-submit" type="button">Ingresar</button>
      <p id="access-feedback" role="alert" class="status-message"></p>
    </div>
  </div>

  <main>
    <header class="hero">
      <div class="hero-content">
        <span class="hero-kicker">POSADA DE PAREJAS 2025</span>
        <h1>Posada de Parejas 2025</h1>
        <span class="hero-location">Tampico</span>
        <div class="countdown" aria-live="polite">
          <div class="time-block">
            <span class="time-value" id="days">00</span>
            <span class="time-label">Días</span>
          </div>
          <div class="time-block">
            <span class="time-value" id="hours">00</span>
            <span class="time-label">Horas</span>
          </div>
          <div class="time-block">
            <span class="time-value" id="minutes">00</span>
            <span class="time-label">Minutos</span>
          </div>
          <div class="time-block">
            <span class="time-value" id="seconds">00</span>
            <span class="time-label">Segundos</span>
          </div>
        </div>
        <audio id="bg-audio" src="posada.mp3" preload="auto"></audio>
      </div>
      <figure class="hero-img">
        <img src="hero_santa.png" alt="Santa con renos modernos">
      </figure>
    </header>

    <section class="info-grid">
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">Datos del evento</h2>
          <span class="pill">29 de Noviembre · 19:00 h</span>
        </div>
        <dl class="meta">
          <div>
            <dt>Fecha</dt>
            <dd>29 de noviembre de 2025</dd>
          </div>
          <div>
            <dt>Hora</dt>
            <dd>19:00 h (CDT -06:00)</dd>
          </div>
          <div>
            <dt>Dress code</dt>
            <dd>Formal</dd>
          </div>
          <div>
            <dt>Lugar</dt>
            <dd>Casa de los Navarrete Feres</dd>
          </div>
          <div>
            <dt>Dirección</dt>
            <dd>Herradura 302A, Col. El Charro, CP 89364, Tampico, Tamaulipas</dd>
          </div>
        </dl>
        <a class="cta-link" href="https://maps.app.goo.gl/6ZbxJhXpWGxEddrS6" target="_blank" rel="noopener">Ver ubicación</a>
      </article>

      <article class="card">
        <div class="card-header">
          <h2 class="card-title">Playlist colaborativa</h2>
          <span class="pill">¡Construyamos el mood!</span>
        </div>
        <p>Curamos una playlist de Spotify para que todos aportemos la vibra perfecta de la noche. Agrega tus canciones favoritas y ayúdanos a construir la memoria musical de la posada.</p>
        <a class="cta-link" href="https://open.spotify.com/playlist/0xlJMquNBMNGLfVCE1j4pU?si=sdt8ObrCQT-CMTrLgXKY5w&pi=7UpYbFdsQmKAL" target="_blank" rel="noopener">Abrir playlist</a>
      </article>
    </section>

    <section class="contribution">
      <h3>Cuota y adelantos</h3>
      <p>Cuota inicial <strong>$500.00 MXN</strong> por invitado para apartar proveedores. Es presupuesto estimado; al final los costos reales se reparten entre el total de asistentes.</p>
      <div class="account-grid">
        <span><strong>Banco:</strong> Santander</span>
        <span><strong>Cuenta:</strong> 5579 0990 1439 0373</span>
        <span><strong>Nombre:</strong> Humberto González</span>
        <span><strong>Concepto:</strong> Nombres de invitados que transfirieron</span>
      </div>
    </section>

    <section class="stats-section">
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">Panorama en vivo</h2>
          <span class="pill" id="last-update">Actualizado hace un momento</span>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-label">Invitados confirmados</span>
            <span class="stat-value" id="stat-confirmed">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Con pago registrado</span>
            <span class="stat-value" id="stat-paid">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Budget recabado</span>
            <span class="stat-value" id="stat-budget">$0</span>
          </div>
        </div>
        <div class="chart-grid">
          <div class="chart-card">
            <h4>Confirmados vs Pagados</h4>
            <canvas id="bar-chart" class="chart" width="480" height="270" aria-label="Gráfica de barras confirmados vs pagados" role="img"></canvas>
          </div>
          <div class="chart-card">
            <h4>Distribución por comité</h4>
            <canvas id="pie-chart" class="chart" width="480" height="270" aria-label="Gráfica de pastel por comités" role="img"></canvas>
          </div>
        </div>
      </article>
    </section>

    <section>
      <form id="rsvp-form">
        <h2 class="card-title">Confirma tu asistencia</h2>
        <div class="form-grid">
          <label>
            Nombre*
            <input type="text" name="nombre" required autocomplete="given-name">
          </label>
          <label>
            Apellido*
            <input type="text" name="apellido" required autocomplete="family-name">
          </label>
          <label>
            Asistencia*
            <select name="asistencia" required>
              <option value="">Selecciona</option>
              <option value="Sí">Sí</option>
              <option value="No">No</option>
            </select>
          </label>
          <label>
            ¿Participas en la organización?
            <select name="participa" id="participa">
              <option value="No">No</option>
              <option value="Sí">Sí</option>
            </select>
          </label>
          <label class="full hidden" id="comite-wrapper">
            Comité*
            <select name="comite" id="comite">
              <option value="">Selecciona comité</option>
            </select>
          </label>
          <label class="full">
            Comentarios / Restricciones
            <textarea name="comentarios" placeholder="Cuéntanos tus necesidades, alergias o ideas."></textarea>
          </label>
          <label>
            Monto pagado (MXN)
            <input type="number" name="montoPagado" min="0" step="0.01" placeholder="Ej. 500">
          </label>
          <label>
            Fecha de depósito
            <input type="date" name="fechaDeposito">
          </label>
          <label class="full">
            Ficha de depósito (PDF/JPG/PNG, máx. 4 MB)
            <input type="file" name="ficha" accept=".pdf,.jpg,.jpeg,.png">
          </label>
        </div>
        <div class="form-actions">
          <span class="status-message" id="form-status" role="status"></span>
          <button type="submit">Enviar RSVP</button>
        </div>
      </form>
    </section>
  </main>

  <footer>© Posada de Parejas 2025 – Casa de los Navarrete Feres.</footer>

  <script>
    const FORM_ENDPOINT = "YOUR_APPS_SCRIPT_WEB_APP_URL";
    const READ_ENDPOINT = "";
    const ACCESS_HASH = "15f2e37004fb9837d1ff1e0edba3f118a81855f2ddc52451f3ce44a1737bfc3c";

    const state = {
      submissions: [],
      committeeLimits: {},
      committeeCounts: {},
      totalConfirmed: 0,
      totalPaid: 0,
      totalBudget: 0,
      confettiTimeout: null
    };

    let experienceInitialized = false;

    const committees = [
      "Comité de Comida, Mesas & Losa",
      "Comité de Bebidas, Alcohol & Shots",
      "Comité de Música & Ambiente",
      "Comité de Juegos & Dinámicas",
      "Comité de Decoración & Fotografía",
      "Comité de Mensaje & Espíritu Navideño",
      "Comité de Orden & Limpieza",
      "Comité de Estrategia & Finanzas"
    ];

    const countdownTarget = new Date('2025-11-30T01:00:00.000Z'); // 19:00 CDT (-06:00)

    const accessOverlay = document.getElementById('access-overlay');
    const accessPassword = document.getElementById('access-password');
    const accessSubmit = document.getElementById('access-submit');
    const accessFeedback = document.getElementById('access-feedback');
    const audio = document.getElementById('bg-audio');
    const form = document.getElementById('rsvp-form');
    const statusMessage = document.getElementById('form-status');
    const participaSelect = document.getElementById('participa');
    const comiteWrapper = document.getElementById('comite-wrapper');
    const comiteSelect = document.getElementById('comite');
    const statConfirmed = document.getElementById('stat-confirmed');
    const statPaid = document.getElementById('stat-paid');
    const statBudget = document.getElementById('stat-budget');
    const lastUpdate = document.getElementById('last-update');

    const barCanvas = document.getElementById('bar-chart');
    const pieCanvas = document.getElementById('pie-chart');
    const barCtx = barCanvas.getContext('2d');
    const pieCtx = pieCanvas.getContext('2d');
    const snowCanvas = document.getElementById('snow-canvas');
    const snowCtx = snowCanvas.getContext('2d');
    const confettiCanvas = document.getElementById('confetti-canvas');
    const confettiCtx = confettiCanvas.getContext('2d');

    let snowflakes = [];
    let snowAnimationId;

    function resizeCanvases() {
      const dpr = window.devicePixelRatio || 1;
      [snowCanvas, confettiCanvas].forEach(canvas => {
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
      });
    }

    function handleResize() {
      resizeCanvases();
      initSnowflakes();
    }

    window.addEventListener('resize', handleResize);

    async function hashValue(value) {
      const encoder = new TextEncoder();
      const data = encoder.encode(value);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function validateAccess() {
      const password = accessPassword.value.trim();
      if (!password) {
        accessFeedback.textContent = 'La contraseña es obligatoria.';
        return;
      }
      const hashed = await hashValue(password);
      if (hashed === ACCESS_HASH) {
        sessionStorage.setItem('posadaAccess', 'true');
        unlockExperience();
      } else {
        accessFeedback.textContent = 'Contraseña incorrecta. Inténtalo de nuevo.';
      }
    }

    function unlockExperience() {
      accessOverlay.classList.add('hidden');
      setTimeout(() => {
        accessOverlay.style.display = 'none';
      }, 400);
      initExperience();
    }

    function setupAccessGate() {
      const unlocked = sessionStorage.getItem('posadaAccess') === 'true';
      if (unlocked) {
        unlockExperience();
      } else {
        accessOverlay.classList.remove('hidden');
        accessPassword.focus();
      }
    }

    accessSubmit.addEventListener('click', validateAccess);
    accessPassword.addEventListener('keydown', event => {
      if (event.key === 'Enter') {
        validateAccess();
      }
    });

    let audioUnlocked = false;

    function attemptAudioPlayback() {
      if (audioUnlocked) return;
      audioUnlocked = true;
      audio.volume = 0.6;
      audio.play().catch(() => {
        document.addEventListener('click', handleFirstInteraction, { once: true });
        document.addEventListener('keydown', handleFirstInteraction, { once: true });
      });
    }

    function handleFirstInteraction() {
      audio.play().catch(() => {});
    }

    function startCountdown() {
      function update() {
        const now = new Date();
        const diff = countdownTarget - now;
        if (diff <= 0) {
          document.getElementById('days').textContent = '00';
          document.getElementById('hours').textContent = '00';
          document.getElementById('minutes').textContent = '00';
          document.getElementById('seconds').textContent = '00';
          return;
        }
        const seconds = Math.floor(diff / 1000) % 60;
        const minutes = Math.floor(diff / (1000 * 60)) % 60;
        const hours = Math.floor(diff / (1000 * 60 * 60)) % 24;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        document.getElementById('days').textContent = String(days).padStart(2, '0');
        document.getElementById('hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
      }
      update();
      setInterval(update, 1000);
    }

    function populateCommittees() {
      comiteSelect.innerHTML = '<option value="">Selecciona comité</option>';
      committees.forEach(comite => {
        const option = document.createElement('option');
        option.value = comite;
        option.textContent = comite;
        comiteSelect.appendChild(option);
      });
    }

    function updateCommitteeState() {
      const participa = participaSelect.value;
      if (participa === 'Sí') {
        comiteWrapper.classList.remove('hidden');
        comiteSelect.setAttribute('required', 'required');
      } else {
        comiteWrapper.classList.add('hidden');
        comiteSelect.removeAttribute('required');
        comiteSelect.value = '';
      }
    }

    participaSelect.addEventListener('change', updateCommitteeState);

    async function readExistingData() {
      if (!READ_ENDPOINT) {
        updateMetrics();
        return;
      }
      try {
        const response = await fetch(READ_ENDPOINT);
        if (!response.ok) throw new Error('Error al leer datos');
        const data = await response.json();
        state.submissions = Array.isArray(data) ? data : (Array.isArray(data.records) ? data.records : []);
      } catch (error) {
        console.error(error);
        statusMessage.textContent = 'No fue posible sincronizar datos remotos. Se usará el estado local.';
      } finally {
        updateMetrics();
      }
    }

    function computeCommitteeLimits() {
      const confirmedCount = state.submissions.filter(item => item.asistencia === 'Sí').length;
      const maxPerCommittee = Math.ceil(Math.max(confirmedCount, 1) / committees.length) || 1;
      committees.forEach(comite => {
        state.committeeLimits[comite] = maxPerCommittee;
      });
    }

    function updateMetrics() {
      computeCommitteeLimits();
      state.committeeCounts = committees.reduce((acc, key) => ({ ...acc, [key]: 0 }), {});

      state.totalConfirmed = 0;
      state.totalPaid = 0;
      state.totalBudget = 0;

      state.submissions.forEach(item => {
        const asistencia = ((item.asistencia ?? '') + '').trim();
        if (asistencia === 'Sí') {
          state.totalConfirmed += 1;
        }
        const monto = parseFloat(item.montoPagado || item.monto_pagado || 0);
        const fecha = item.fechaDeposito || item.fecha_deposito;
        if (!Number.isNaN(monto) && monto > 0) {
          if (fecha) state.totalPaid += 1;
          state.totalBudget += monto;
        }
        const participa = ((item.participa ?? '') + '').trim();
        if (participa === 'Sí' && item.comite) {
          state.committeeCounts[item.comite] = (state.committeeCounts[item.comite] || 0) + 1;
        }
      });

      refreshCommitteeOptions();
      renderStats();
      renderCharts();
      lastUpdate.textContent = `Actualizado ${new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}`;
    }

    function refreshCommitteeOptions() {
      Array.from(comiteSelect.options).forEach(option => {
        if (!option.value) return;
        const used = state.committeeCounts[option.value] || 0;
        const limit = state.committeeLimits[option.value] || Infinity;
        option.disabled = used >= limit;
        if (option.disabled && comiteSelect.value === option.value) {
          comiteSelect.value = '';
        }
      });
    }

    function renderStats() {
      statConfirmed.textContent = state.totalConfirmed;
      statPaid.textContent = state.totalPaid;
      statBudget.textContent = state.totalBudget.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 });
    }

    function drawRoundedRect(ctx, x, y, width, height, radius) {
      const r = Math.min(radius, width / 2, height / 2);
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + width - r, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + r);
      ctx.lineTo(x + width, y + height - r);
      ctx.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
      ctx.lineTo(x + r, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    function adjustChartCanvas(canvas, ctx) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const width = Math.max(1, Math.floor(rect.width * dpr));
      const height = Math.max(1, Math.floor(rect.height * dpr));
      if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
      }
    }

    function renderCharts() {
      adjustChartCanvas(barCanvas, barCtx);
      adjustChartCanvas(pieCanvas, pieCtx);

      const barRect = barCanvas.getBoundingClientRect();
      const pieRect = pieCanvas.getBoundingClientRect();

      // BARRAS
      barCtx.clearRect(0, 0, barRect.width, barRect.height);
      const padding = 48;
      const chartWidth = Math.max(0, barRect.width - padding * 2);
      const chartHeight = Math.max(0, barRect.height - padding * 2);
      const values = [state.totalConfirmed, state.totalPaid];
      const maxValue = Math.max(...values, 1);
      const barWidth = chartWidth / values.length * 0.5;
      const colors = ['#2af8a5', '#f5d57c'];
      values.forEach((value, index) => {
        const barHeight = (value / maxValue) * chartHeight;
        const x = padding + index * (chartWidth / values.length) + (chartWidth / values.length - barWidth) / 2;
        const y = padding + chartHeight - barHeight;
        const gradient = barCtx.createLinearGradient(0, y, 0, padding + chartHeight);
        gradient.addColorStop(0, colors[index]);
        gradient.addColorStop(1, 'rgba(255,255,255,0.15)');
        barCtx.fillStyle = gradient;
        drawRoundedRect(barCtx, x, y, barWidth, barHeight, 12);
        barCtx.fill();
        barCtx.fillStyle = 'rgba(255, 255, 255, 0.85)';
        barCtx.font = '16px Inter';
        barCtx.textAlign = 'center';
        barCtx.fillText(value, x + barWidth / 2, y - 12);
        barCtx.font = '12px Inter';
        barCtx.fillStyle = 'rgba(255,255,255,0.55)';
        barCtx.fillText(index === 0 ? 'Confirmados' : 'Pagados', x + barWidth / 2, padding + chartHeight + 20);
      });

      // Pastel
      pieCtx.clearRect(0, 0, pieRect.width, pieRect.height);
      const centerX = pieRect.width / 2;
      const centerY = pieRect.height / 2;
      const radius = Math.min(pieRect.width, pieRect.height) / 3;
      const total = Object.values(state.committeeCounts).reduce((sum, value) => sum + value, 0) || 1;
      let startAngle = -Math.PI / 2;
      committees.forEach((comite, index) => {
        const count = state.committeeCounts[comite] || 0;
        const sliceAngle = (count / total) * Math.PI * 2;
        const gradient = pieCtx.createRadialGradient(centerX, centerY, radius * 0.2, centerX, centerY, radius);
        gradient.addColorStop(0, 'rgba(255,255,255,0.1)');
        const hue = (index / committees.length) * 360;
        gradient.addColorStop(1, `hsla(${hue}, 85%, 65%, 0.9)`);
        pieCtx.beginPath();
        pieCtx.moveTo(centerX, centerY);
        pieCtx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
        pieCtx.closePath();
        pieCtx.fillStyle = gradient;
        pieCtx.fill();
        if (sliceAngle > 0.1) {
          const labelAngle = startAngle + sliceAngle / 2;
          const labelX = centerX + Math.cos(labelAngle) * radius * 0.6;
          const labelY = centerY + Math.sin(labelAngle) * radius * 0.6;
          pieCtx.fillStyle = 'rgba(0,0,0,0.6)';
          pieCtx.beginPath();
          pieCtx.arc(labelX, labelY, 24, 0, Math.PI * 2);
          pieCtx.fill();
          pieCtx.fillStyle = '#fff';
          pieCtx.font = '12px Inter';
          pieCtx.textAlign = 'center';
          pieCtx.textBaseline = 'middle';
          pieCtx.fillText(String(count), labelX, labelY);
        }
        startAngle += sliceAngle;
      });
    }

    function initSnowflakes() {
      const density = Math.floor(window.innerWidth / 8);
      snowflakes = Array.from({ length: density }, () => ({
        x: Math.random() * window.innerWidth,
        y: Math.random() * window.innerHeight,
        radius: Math.random() * 2 + 1,
        speed: Math.random() * 1.2 + 0.4,
        drift: Math.random() * 0.6 - 0.3
      }));
    }

    function animateSnow() {
      snowCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
      snowCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      snowflakes.forEach(flake => {
        snowCtx.beginPath();
        snowCtx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2);
        snowCtx.fill();
        flake.y += flake.speed;
        flake.x += flake.drift;
        if (flake.y > window.innerHeight) {
          flake.y = -flake.radius;
          flake.x = Math.random() * window.innerWidth;
        }
        if (flake.x > window.innerWidth) flake.x = 0;
        if (flake.x < 0) flake.x = window.innerWidth;
      });
      snowAnimationId = requestAnimationFrame(animateSnow);
    }

    function startSnow() {
      if (snowAnimationId) {
        cancelAnimationFrame(snowAnimationId);
      }
      initSnowflakes();
      animateSnow();
    }

    function triggerConfetti() {
      const confettiPieces = Array.from({ length: 150 }).map(() => ({
        x: Math.random() * window.innerWidth,
        y: Math.random() * -window.innerHeight,
        radius: Math.random() * 6 + 4,
        color: `hsl(${Math.random() * 360}, 90%, 60%)`,
        velocity: Math.random() * 3 + 2,
        rotation: Math.random() * Math.PI,
        rotationSpeed: Math.random() * 0.2 - 0.1
      }));
      let opacity = 1;
      confettiCanvas.style.opacity = 1;
      function animate() {
        confettiCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        confettiPieces.forEach(piece => {
          confettiCtx.save();
          confettiCtx.translate(piece.x, piece.y);
          confettiCtx.rotate(piece.rotation);
          confettiCtx.fillStyle = piece.color;
          confettiCtx.fillRect(-piece.radius, -piece.radius / 2, piece.radius * 2, piece.radius);
          confettiCtx.restore();
          piece.y += piece.velocity;
          piece.rotation += piece.rotationSpeed;
          if (piece.y > window.innerHeight + 20) {
            piece.y = -20;
          }
        });
        opacity -= 0.005;
        confettiCanvas.style.opacity = Math.max(opacity, 0);
        if (opacity > 0) {
          requestAnimationFrame(animate);
        } else {
          confettiCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        }
      }
      animate();
    }

    function serializeFormData(formData) {
      return {
        nombre: formData.get('nombre')?.trim() || '',
        apellido: formData.get('apellido')?.trim() || '',
        asistencia: formData.get('asistencia') || '',
        comentarios: formData.get('comentarios')?.trim() || '',
        participa: formData.get('participa') || 'No',
        comite: formData.get('comite') || '',
        montoPagado: formData.get('montoPagado') ? parseFloat(formData.get('montoPagado')) : 0,
        fechaDeposito: formData.get('fechaDeposito') || '',
        fichaDeposito: formData.get('fichaDeposito') || '',
        fichaMime: formData.get('fichaMime') || '',
        ts: new Date().toISOString()
      };
    }

    async function handleFileEncoding(file) {
      if (!file) return { fichaDeposito: '', fichaMime: '' };
      if (file.size > 4 * 1024 * 1024) {
        throw new Error('El archivo supera los 4 MB.');
      }
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve({ fichaDeposito: base64, fichaMime: file.type });
        };
        reader.onerror = () => reject(new Error('No se pudo leer el archivo.'));
        reader.readAsDataURL(file);
      });
    }

    async function submitForm(event) {
      event.preventDefault();
      statusMessage.textContent = 'Enviando…';
      statusMessage.classList.remove('error', 'success');
      const formData = new FormData(form);

      if (formData.get('participa') === 'Sí' && !formData.get('comite')) {
        statusMessage.textContent = 'Selecciona un comité disponible.';
        statusMessage.classList.add('error');
        return;
      }

      try {
        const file = formData.get('ficha');
        const { fichaDeposito, fichaMime } = await handleFileEncoding(file && file.size ? file : null);
        formData.delete('ficha');
        formData.append('fichaDeposito', fichaDeposito);
        formData.append('fichaMime', fichaMime);
        const payload = serializeFormData(formData);

        if (!FORM_ENDPOINT || FORM_ENDPOINT === 'YOUR_APPS_SCRIPT_WEB_APP_URL') {
          throw new Error('Configura FORM_ENDPOINT antes de enviar.');
        }

        const response = await fetch(FORM_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Error al enviar el formulario.');

        statusMessage.textContent = '¡Gracias! Tu RSVP se registró correctamente.';
        statusMessage.classList.add('success');
        form.reset();
        updateCommitteeState();

        state.submissions.push(payload);
        updateMetrics();
        triggerConfetti();
      } catch (error) {
        console.error(error);
        statusMessage.textContent = error.message || 'No se pudo enviar tu RSVP.';
        statusMessage.classList.add('error');
      }
    }

    function initExperience() {
      if (experienceInitialized) return;
      experienceInitialized = true;
      attemptAudioPlayback();
      populateCommittees();
      updateCommitteeState();
      resizeCanvases();
      startSnow();
      readExistingData();
      startCountdown();
      form.addEventListener('submit', submitForm);
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupAccessGate();
    });
  </script>
</body>
</html>
